@page "/transactionimport"

@using  BankingCore.Services
@using Domain.Enums
@using Blazor.FileReader
@inject IFileReaderService fileReaderService
@inject HttpClient HttpClient

<h3>Upload </h3>
<input type="file" multiple @ref=inputElement />
<button @onclick="UploadFiles">Upload</button>
<br /><pre>@debug</pre>
@code {
    string debug;
    ElementReference inputElement;
    IFileReaderRef fileReaderReference;

    protected override void OnAfterRender(bool isFirstRender)
    {
        fileReaderReference = fileReaderService.CreateReference(inputElement);
    }

    public async Task UploadFiles()
    {
        var multipartFormDataContent = new MultipartFormDataContent();
        foreach (var file in await fileReaderReference.EnumerateFilesAsync())
        {
            multipartFormDataContent.Add(
                new StreamContent(await file.OpenReadAsync(), 8192),
                "files",
                (await file.ReadFileInfoAsync()).Name);
        }

        var res = await HttpClient.PostAsync(requestUri: "https://localhost:5001/api/upload/files",
                content: multipartFormDataContent);
        debug = await res.Content.ReadAsStringAsync();
    }
}
